---
import { getCollection } from "astro:content";
import Layout from "@layouts/Layout.astro";
import TagList from "@components/TagList";
import PostList from "@components/PostList";

const postEntries = await getCollection("post");
const allTags = [...new Set(postEntries.flatMap((entry) => entry.data.tags))];
const { pathname } = new URL(Astro.request.url);
const selectedTag = decodeURI(pathname.split("/")[2]);
const filterPosts = await getCollection("post", ({ data }) => {
  return data.tags.includes(selectedTag);
});

export async function getStaticPaths() {
  const postEntries = await getCollection("post");

  return postEntries
    .flatMap(({ data }) => data.tags)
    .map((tag) => ({
      params: { slug: tag },
    }));
}
---

<Layout title={selectedTag}>
  <TagList tags={allTags} selectedTag={selectedTag} isActivate />
  <PostList posts={filterPosts} />
</Layout>

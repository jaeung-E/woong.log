---
import { CollectionEntry, getCollection } from "astro:content";
import Layout from "@layouts/Layout.astro";
import TagList from "@components/TagList.astro";
import PostList from "@components/PostList";
import MetaData from "@layouts/MetaData.astro";

interface Props {
  postEntries: CollectionEntry<"post">[];
}

export async function getStaticPaths() {
  const postEntries = await getCollection("post");

  return postEntries
    .flatMap(({ data }) => data.tags)
    .map((tag) => ({
      params: { slug: tag },
      props: { postEntries },
    }));
}

const { postEntries } = Astro.props;
const allTags = [...new Set(postEntries.flatMap((entry) => entry.data.tags))];
const { pathname } = new URL(Astro.request.url);
const selectedTag = decodeURI(pathname.split("/")[2]);
const filterPosts = await getCollection("post", ({ data }) => {
  return data.tags.includes(selectedTag);
});
---

<Layout>
  <MetaData
    title={`${selectedTag} | Woong.log`}
    description={`${selectedTag} Posts`}
    slot="meta"
  />
  <TagList tags={allTags} selectedTag={selectedTag} isActivate />
  <PostList posts={filterPosts} />
</Layout>
